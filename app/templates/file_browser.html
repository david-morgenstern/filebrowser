<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Browser</title>
    <link href="{{ url_for('static', path='custom.css') }}" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', path='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-folder-open"></i> Files
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search files...">
            </div>
            <button class="btn-icon" onclick="showHistory()" title="Watch History" style="margin-left: auto;">
                <i class="fas fa-history"></i>
            </button>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        {% for crumb in breadcrumbs %}
            <a href="/{{ crumb.path }}" class="{% if loop.last %}active{% endif %}">
                {% if loop.first %}<i class="fas fa-home"></i>{% endif %}
                {{ crumb.name }}
            </a>
            {% if not loop.last %}
                <span class="separator">/</span>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Container -->
    <div class="container">
        <ul class="file-list" id="fileList">
            {% if directories|length == 0 and files|length == 0 %}
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>Empty folder</h3>
            </div>
            {% endif %}

            <!-- Directories -->
            {% for directory in directories %}
            <li data-name="{{ directory.name|lower }}">
                <div class="file-icon folder">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">{{ directory.name }}</div>
                    <div class="file-meta">Folder</div>
                </div>
                <div class="file-actions">
                    <a href="/{{ current_path }}{% if current_path %}/{% endif %}{{ directory.name }}" class="btn-icon" title="Open">
                        <i class="fas fa-folder-open"></i>
                    </a>
                    <form action="/download" method="post" style="display: inline;">
                        <input type="hidden" name="file_path" value="{{ directory.path }}">
                        <input type="hidden" name="file_name" value="{{ directory.name }}">
                        <button type="submit" class="btn-icon" title="Download ZIP">
                            <i class="fas fa-download"></i>
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}

            <!-- Files -->
            {% for file in files %}
            <li data-name="{{ file.name|lower }}">
                <div class="file-icon {{ file.type }}">
                    {% if file.type == 'video' %}
                        <i class="fas fa-film"></i>
                    {% elif file.type == 'image' %}
                        <i class="fas fa-image"></i>
                    {% elif file.type == 'audio' %}
                        <i class="fas fa-music"></i>
                    {% elif file.type == 'text' %}
                        <i class="fas fa-file-alt"></i>
                    {% elif file.type == 'pdf' %}
                        <i class="fas fa-file-pdf"></i>
                    {% elif file.type == 'archive' %}
                        <i class="fas fa-file-archive"></i>
                    {% else %}
                        <i class="fas fa-file"></i>
                    {% endif %}
                </div>
                <div class="file-info">
                    <div class="file-name">{{ file.name }}</div>
                    <div class="file-meta">{{ file.size|filesizeformat }} • {{ file.type|title }}</div>
                </div>
                <div class="file-actions">
                    {% if file.type in ['video', 'audio', 'image', 'text'] %}
                    <button class="btn-icon" onclick='viewFile("{{ file.relative_path }}", "{{ file.type }}", "{{ file.name|replace("\"", "\\\"") }}")' title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% endif %}
                    <form action="/download" method="post" style="display: inline;">
                        <input type="hidden" name="file_path" value="{{ file.path }}">
                        <input type="hidden" name="file_name" value="{{ file.name }}">
                        <button type="submit" class="btn-icon" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <button class="modal-close" onclick="closeModal()">×</button>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('#fileList li[data-name]').forEach(li => {
                const name = li.dataset.name;
                li.style.display = name.includes(search) ? '' : 'none';
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            if (e.key === 'Escape') {
                closeModal();
                if (document.activeElement === document.getElementById('searchInput')) {
                    document.getElementById('searchInput').blur();
                }
            }
        });

        // Get MIME type from filename
        function getMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                // Video
                'mp4': 'video/mp4', 'm4v': 'video/mp4', 'webm': 'video/webm',
                'mkv': 'video/x-matroska', 'avi': 'video/x-msvideo',
                'mov': 'video/quicktime', 'flv': 'video/x-flv', 'wmv': 'video/x-ms-wmv',
                // Audio
                'mp3': 'audio/mpeg', 'm4a': 'audio/mp4', 'aac': 'audio/aac',
                'wav': 'audio/wav', 'flac': 'audio/flac', 'ogg': 'audio/ogg',
                'oga': 'audio/ogg', 'opus': 'audio/opus'
            };
            return mimeTypes[ext] || '';
        }

        // View file
        function viewFile(path, type, name) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');

            // Properly encode the path for URL
            const encodedPath = path.split('/').map(p => encodeURIComponent(p)).join('/');
            const streamUrl = '/stream/' + encodedPath;
            const mimeType = getMimeType(name);

            console.log('Opening file:', {path, type, name, streamUrl, mimeType});

            if (type === 'image') {
                content.innerHTML = `<img src="${streamUrl}" alt="${escapeHtml(name)}" onerror="console.error('Failed to load image:', this.src)">`;
            } else if (type === 'video') {
                // Check if file needs transcoding
                const ext = name.toLowerCase().split('.').pop();
                const needsTranscode = ['avi', 'wmv', 'flv'].includes(ext);

                if (needsTranscode) {
                    // Use transcode endpoint with metadata
                    console.log('Using transcode with metadata for', ext);

                    content.innerHTML = `
                        <div id="transcodeNotice" style="background: rgba(33, 150, 243, 0.1); padding: 0.5rem; text-align: center; color: #2196F3; font-size: 0.85rem; margin-bottom: 0.5rem;">
                            ⚡ Loading video metadata...
                        </div>
                        <div style="position: relative;">
                            <video id="videoPlayer" controls preload="auto" style="width: 100%; height: auto; background: #000;">
                                <source src="/transcode/${encodedPath}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div id="durationDisplay" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 14px; display: none;"></div>
                        </div>
                        <div class="media-info">${escapeHtml(name)}</div>
                    `;

                    const video = document.getElementById('videoPlayer');
                    const notice = document.getElementById('transcodeNotice');
                    const durationDisplay = document.getElementById('durationDisplay');

                    // Fetch metadata
                    fetch('/api/video-info/' + encodedPath)
                        .then(r => r.json())
                        .then(metadata => {
                            console.log('Video metadata:', metadata);
                            const duration = metadata.duration;
                            const minutes = Math.floor(duration / 60);
                            const seconds = Math.floor(duration % 60);

                            notice.textContent = `⚡ Streaming ${metadata.codec.toUpperCase()} video (Duration: ${minutes}:${seconds.toString().padStart(2, '0')})`;

                            // Update duration display
                            video.addEventListener('timeupdate', () => {
                                const currentMinutes = Math.floor(video.currentTime / 60);
                                const currentSeconds = Math.floor(video.currentTime % 60);
                                durationDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${minutes}:${seconds.toString().padStart(2, '0')}`;
                                durationDisplay.style.display = 'block';
                            });

                            // Try to set duration via durationchange event
                            video.addEventListener('durationchange', () => {
                                console.log('Duration from video element:', video.duration);
                                if (video.duration === Infinity || isNaN(video.duration)) {
                                    // Force set duration using metadata
                                    console.log('Setting duration from metadata:', duration);
                                    // Note: We can't directly set video.duration, but we can handle seeking manually
                                }
                            });
                        })
                        .catch(err => {
                            console.error('Failed to get video metadata:', err);
                            notice.textContent = '⚠️ Could not load video metadata';
                        });

                    // Add event listeners
                    video.addEventListener('loadedmetadata', () => {
                        console.log('✓ Video: Metadata loaded, duration:', video.duration);
                    });
                    video.addEventListener('error', (e) => {
                        console.error('✗ Video error:', e, video.error);
                    });
                } else {
                    // Use direct streaming for supported formats
                    content.innerHTML = `
                        <video id="videoPlayer" controls preload="auto" style="width: 100%; height: auto; background: #000;">
                            <source src="${streamUrl}" type="${mimeType}">
                            Your browser does not support the video tag.
                        </video>
                        <div class="media-info">${escapeHtml(name)}</div>
                    `;

                    const video = document.getElementById('videoPlayer');
                    video.addEventListener('loadedmetadata', () => console.log('✓ Video: Metadata loaded, duration:', video.duration));
                    video.addEventListener('error', (e) => console.error('✗ Video error:', e, video.error));
                }

                console.log('Video element created for', name);
            } else if (type === 'audio') {
                const audioHtml = `
                    <audio id="audioPlayer" controls preload="auto" style="width: 100%;">
                        <source src="${streamUrl}" type="${mimeType}">
                        Your browser does not support the audio tag.
                    </audio>
                    <div class="media-info">${escapeHtml(name)}</div>
                `;
                content.innerHTML = audioHtml;

                const audio = document.getElementById('audioPlayer');
                audio.addEventListener('error', (e) => {
                    console.error('Audio error:', e, audio.error);
                });
                audio.load();
            } else if (type === 'text') {
                fetch('/preview/' + encodedPath)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    })
                    .then(text => {
                        content.innerHTML = `
                            <div class="text-preview">
                                <div class="text-preview-header">${escapeHtml(name)}</div>
                                <div class="text-preview-content">${escapeHtml(text)}</div>
                            </div>
                        `;
                    })
                    .catch(err => {
                        console.error('Failed to load text:', err);
                        content.innerHTML = `<div style="color: white; padding: 2rem;">Error loading file: ${err.message}</div>`;
                    });
            }

            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');

            // Stop any playing media
            const video = document.getElementById('videoPlayer');
            const audio = document.getElementById('audioPlayer');
            if (video) {
                video.pause();
                video.src = '';
            }
            if (audio) {
                audio.pause();
                audio.src = '';
            }

            modal.classList.remove('active');
            content.innerHTML = '';
        }

        // Click outside to close
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show watch history
        async function showHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();

                const modal = document.getElementById('modal');
                const content = document.getElementById('modalContent');

                if (data.count === 0) {
                    content.innerHTML = `
                        <div class="text-preview">
                            <div class="text-preview-header">Watch History</div>
                            <div style="padding: 2rem; text-align: center; color: #666;">
                                No watch history yet
                            </div>
                        </div>
                    `;
                } else {
                    let historyHtml = `
                        <div class="text-preview">
                            <div class="text-preview-header">Watch History (${data.count} items)</div>
                            <div style="padding: 1rem;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #e0e0e0;">
                                            <th style="padding: 0.5rem; text-align: left;">File</th>
                                            <th style="padding: 0.5rem; text-align: left;">Type</th>
                                            <th style="padding: 0.5rem; text-align: right;">Views</th>
                                            <th style="padding: 0.5rem; text-align: right;">Last Watched</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    data.history.forEach(item => {
                        const lastWatched = new Date(item.last_watched).toLocaleString();
                        const fileType = item.file_type.charAt(0).toUpperCase() + item.file_type.slice(1);

                        historyHtml += `
                            <tr style="border-bottom: 1px solid #f0f0f0; cursor: pointer;"
                                onclick='viewFile("${item.file_path}", "${item.file_type}", "${escapeHtml(item.file_name)}")'>
                                <td style="padding: 0.75rem;">${escapeHtml(item.file_name)}</td>
                                <td style="padding: 0.75rem;">${fileType}</td>
                                <td style="padding: 0.75rem; text-align: right;">${item.view_count}</td>
                                <td style="padding: 0.75rem; text-align: right; font-size: 0.85rem; color: #666;">${lastWatched}</td>
                            </tr>
                        `;
                    });

                    historyHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    content.innerHTML = historyHtml;
                }

                modal.classList.add('active');
            } catch (error) {
                console.error('Failed to load history:', error);
                alert('Failed to load watch history');
            }
        }
    </script>
</body>
</html>
