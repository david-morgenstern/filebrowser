<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Browser</title>
    <link href="{{ url_for('static', path='custom.css') }}" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', path='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-folder-open"></i> Files
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search files...">
            </div>
            <button class="btn-icon" onclick="showHistory()" title="Watch History" style="margin-left: auto;">
                <i class="fas fa-history"></i>
            </button>
        </div>
    </div>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        {% for crumb in breadcrumbs %}
            <a href="/{{ crumb.path }}" class="{% if loop.last %}active{% endif %}">
                {% if loop.first %}<i class="fas fa-home"></i>{% endif %}
                {{ crumb.name }}
            </a>
            {% if not loop.last %}
                <span class="separator">/</span>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Container -->
    <div class="container">
        <ul class="file-list" id="fileList">
            {% if directories|length == 0 and files|length == 0 %}
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>Empty folder</h3>
            </div>
            {% endif %}

            <!-- Directories -->
            {% for directory in directories %}
            <li data-name="{{ directory.name|lower }}">
                <div class="file-icon folder">
                    <i class="fas fa-folder"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">{{ directory.name }}</div>
                    <div class="file-meta">Folder</div>
                </div>
                <div class="file-actions">
                    <a href="/{{ current_path }}{% if current_path %}/{% endif %}{{ directory.name }}" class="btn-icon" title="Open">
                        <i class="fas fa-folder-open"></i>
                    </a>
                    <form action="/download" method="post" style="display: inline;">
                        <input type="hidden" name="file_path" value="{{ directory.path }}">
                        <input type="hidden" name="file_name" value="{{ directory.name }}">
                        <button type="submit" class="btn-icon" title="Download ZIP">
                            <i class="fas fa-download"></i>
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}

            <!-- Files -->
            {% for file in files %}
            <li data-name="{{ file.name|lower }}">
                <div class="file-icon {{ file.type }}">
                    {% if file.type == 'video' %}
                        <i class="fas fa-film"></i>
                    {% elif file.type == 'image' %}
                        <i class="fas fa-image"></i>
                    {% elif file.type == 'audio' %}
                        <i class="fas fa-music"></i>
                    {% elif file.type == 'text' %}
                        <i class="fas fa-file-alt"></i>
                    {% elif file.type == 'pdf' %}
                        <i class="fas fa-file-pdf"></i>
                    {% elif file.type == 'archive' %}
                        <i class="fas fa-file-archive"></i>
                    {% else %}
                        <i class="fas fa-file"></i>
                    {% endif %}
                </div>
                <div class="file-info">
                    <div class="file-name">{{ file.name }}</div>
                    <div class="file-meta">{{ file.size|filesizeformat }} • {{ file.type|title }}</div>
                </div>
                <div class="file-actions">
                    {% if file.type in ['video', 'audio', 'image', 'text'] %}
                    <button class="btn-icon" onclick='viewFile("{{ file.relative_path }}", "{{ file.type }}", "{{ file.name|replace("\"", "\\\"") }}")' title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% endif %}
                    <form action="/download" method="post" style="display: inline;">
                        <input type="hidden" name="file_path" value="{{ file.path }}">
                        <input type="hidden" name="file_name" value="{{ file.name }}">
                        <button type="submit" class="btn-icon" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <button class="modal-close" onclick="closeModal()">×</button>
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const search = e.target.value.toLowerCase();
            document.querySelectorAll('#fileList li[data-name]').forEach(li => {
                const name = li.dataset.name;
                li.style.display = name.includes(search) ? '' : 'none';
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === '/' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            if (e.key === 'Escape') {
                closeModal();
                if (document.activeElement === document.getElementById('searchInput')) {
                    document.getElementById('searchInput').blur();
                }
            }
        });

        // Get MIME type from filename
        function getMimeType(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const mimeTypes = {
                // Video
                'mp4': 'video/mp4', 'm4v': 'video/mp4', 'webm': 'video/webm',
                'mkv': 'video/x-matroska', 'avi': 'video/x-msvideo',
                'mov': 'video/quicktime', 'flv': 'video/x-flv', 'wmv': 'video/x-ms-wmv',
                // Audio
                'mp3': 'audio/mpeg', 'm4a': 'audio/mp4', 'aac': 'audio/aac',
                'wav': 'audio/wav', 'flac': 'audio/flac', 'ogg': 'audio/ogg',
                'oga': 'audio/ogg', 'opus': 'audio/opus'
            };
            return mimeTypes[ext] || '';
        }

        // View file
        function viewFile(path, type, name) {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');

            // Properly encode the path for URL
            const encodedPath = path.split('/').map(p => encodeURIComponent(p)).join('/');
            const streamUrl = '/stream/' + encodedPath;
            const mimeType = getMimeType(name);

            console.log('Opening file:', {path, type, name, streamUrl, mimeType});

            if (type === 'image') {
                content.innerHTML = `<img src="${streamUrl}" alt="${escapeHtml(name)}" onerror="console.error('Failed to load image:', this.src)">`;
            } else if (type === 'video') {
                // Check if file needs transcoding
                const ext = name.toLowerCase().split('.').pop();
                const needsTranscode = ['avi', 'wmv', 'flv'].includes(ext);

                if (needsTranscode) {
                    // Use transcode endpoint with metadata and custom seeking
                    console.log('Using transcode with metadata and seeking for', ext);

                    content.innerHTML = `
                        <div id="transcodeNotice" style="background: rgba(33, 150, 243, 0.1); padding: 0.5rem; text-align: center; color: #2196F3; font-size: 0.85rem; margin-bottom: 0.5rem;">
                            ⚡ Loading video metadata...
                        </div>
                        <div style="position: relative;">
                            <video id="videoPlayer" preload="auto" style="width: 100%; height: auto; background: #000; display: block;">
                                <source src="/transcode/${encodedPath}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <div id="customControls" style="background: rgba(0,0,0,0.8); padding: 10px; display: flex; align-items: center; gap: 10px;">
                                <button id="playPauseBtn" style="background: #2196F3; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer;">Play</button>
                                <span id="currentTime" style="color: white; font-size: 14px; min-width: 45px;">0:00</span>
                                <div id="seekBar" style="flex: 1; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; position: relative;">
                                    <div id="seekProgress" style="height: 100%; background: #2196F3; border-radius: 4px; width: 0%;"></div>
                                    <div id="bufferedProgress" style="position: absolute; top: 0; height: 100%; background: rgba(255,255,255,0.5); border-radius: 4px; width: 0%;"></div>
                                </div>
                                <span id="totalTime" style="color: white; font-size: 14px; min-width: 45px;">0:00</span>
                                <button id="fullscreenBtn" style="background: #2196F3; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer;">Fullscreen</button>
                            </div>
                        </div>
                        <div class="media-info">${escapeHtml(name)}</div>
                    `;

                    const video = document.getElementById('videoPlayer');
                    const notice = document.getElementById('transcodeNotice');
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    const seekBar = document.getElementById('seekBar');
                    const seekProgress = document.getElementById('seekProgress');
                    const bufferedProgress = document.getElementById('bufferedProgress');
                    const currentTimeDisplay = document.getElementById('currentTime');
                    const totalTimeDisplay = document.getElementById('totalTime');
                    const fullscreenBtn = document.getElementById('fullscreenBtn');

                    let videoDuration = 0;
                    let currentStartTime = 0;
                    let isSeeking = false;
                    let wasPlaying = false;

                    function formatTime(seconds) {
                        const mins = Math.floor(seconds / 60);
                        const secs = Math.floor(seconds % 60);
                        return `${mins}:${secs.toString().padStart(2, '0')}`;
                    }

                    // Fetch metadata
                    fetch('/api/video-info/' + encodedPath)
                        .then(r => r.json())
                        .then(metadata => {
                            console.log('Video metadata:', metadata);
                            videoDuration = metadata.duration;
                            totalTimeDisplay.textContent = formatTime(videoDuration);

                            notice.textContent = `⚡ Streaming ${metadata.codec.toUpperCase()} video (Duration: ${formatTime(videoDuration)}) - Click timeline to seek`;
                        })
                        .catch(err => {
                            console.error('Failed to get video metadata:', err);
                            notice.textContent = '⚠️ Could not load video metadata';
                        });

                    // Play/Pause button
                    playPauseBtn.addEventListener('click', () => {
                        if (video.paused) {
                            video.play();
                            playPauseBtn.textContent = 'Pause';
                        } else {
                            video.pause();
                            playPauseBtn.textContent = 'Play';
                        }
                    });

                    // Update play button on video state change
                    video.addEventListener('play', () => playPauseBtn.textContent = 'Pause');
                    video.addEventListener('pause', () => playPauseBtn.textContent = 'Play');

                    // Time update
                    video.addEventListener('timeupdate', () => {
                        if (!isSeeking && videoDuration > 0) {
                            const adjustedTime = currentStartTime + video.currentTime;
                            const progress = (adjustedTime / videoDuration) * 100;
                            seekProgress.style.width = progress + '%';
                            currentTimeDisplay.textContent = formatTime(adjustedTime);
                        }
                    });

                    // Buffered progress
                    video.addEventListener('progress', () => {
                        if (video.buffered.length > 0 && videoDuration > 0) {
                            const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                            const adjustedBuffered = currentStartTime + bufferedEnd;
                            const bufferProgress = (adjustedBuffered / videoDuration) * 100;
                            bufferedProgress.style.width = bufferProgress + '%';
                        }
                    });

                    // Seeking
                    seekBar.addEventListener('click', (e) => {
                        if (videoDuration === 0) return;

                        const rect = seekBar.getBoundingClientRect();
                        const clickX = e.clientX - rect.left;
                        const percentage = clickX / rect.width;
                        const seekToTime = percentage * videoDuration;

                        console.log('Seeking to:', seekToTime);

                        // Remember if video was playing
                        wasPlaying = !video.paused;
                        isSeeking = true;

                        // Pause current video
                        video.pause();

                        // Update current start time
                        currentStartTime = seekToTime;

                        // Load new stream from seek position
                        video.src = '/transcode/' + encodedPath + '?start_time=' + seekToTime;
                        video.load();

                        // Update UI immediately
                        seekProgress.style.width = (percentage * 100) + '%';
                        currentTimeDisplay.textContent = formatTime(seekToTime);

                        // Resume playback if was playing
                        if (wasPlaying) {
                            video.play().then(() => {
                                isSeeking = false;
                                console.log('Resumed playback from', seekToTime);
                            }).catch(err => {
                                console.error('Failed to resume playback:', err);
                                isSeeking = false;
                            });
                        } else {
                            isSeeking = false;
                        }
                    });

                    // Fullscreen
                    fullscreenBtn.addEventListener('click', () => {
                        const container = video.parentElement;
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        } else {
                            container.requestFullscreen();
                        }
                    });

                    // Auto-play on load
                    video.addEventListener('loadeddata', () => {
                        console.log('✓ Video: Data loaded');
                        if (currentStartTime === 0) {
                            video.play().catch(e => console.log('Auto-play prevented:', e));
                        }
                    });

                    video.addEventListener('error', (e) => {
                        console.error('✗ Video error:', e, video.error);
                    });
                } else {
                    // Use direct streaming for supported formats
                    content.innerHTML = `
                        <video id="videoPlayer" controls preload="auto" style="width: 100%; height: auto; background: #000;">
                            <source src="${streamUrl}" type="${mimeType}">
                            Your browser does not support the video tag.
                        </video>
                        <div class="media-info">${escapeHtml(name)}</div>
                    `;

                    const video = document.getElementById('videoPlayer');
                    video.addEventListener('loadedmetadata', () => console.log('✓ Video: Metadata loaded, duration:', video.duration));
                    video.addEventListener('error', (e) => console.error('✗ Video error:', e, video.error));
                }

                console.log('Video element created for', name);
            } else if (type === 'audio') {
                const audioHtml = `
                    <audio id="audioPlayer" controls preload="auto" style="width: 100%;">
                        <source src="${streamUrl}" type="${mimeType}">
                        Your browser does not support the audio tag.
                    </audio>
                    <div class="media-info">${escapeHtml(name)}</div>
                `;
                content.innerHTML = audioHtml;

                const audio = document.getElementById('audioPlayer');
                audio.addEventListener('error', (e) => {
                    console.error('Audio error:', e, audio.error);
                });
                audio.load();
            } else if (type === 'text') {
                fetch('/preview/' + encodedPath)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.text();
                    })
                    .then(text => {
                        content.innerHTML = `
                            <div class="text-preview">
                                <div class="text-preview-header">${escapeHtml(name)}</div>
                                <div class="text-preview-content">${escapeHtml(text)}</div>
                            </div>
                        `;
                    })
                    .catch(err => {
                        console.error('Failed to load text:', err);
                        content.innerHTML = `<div style="color: white; padding: 2rem;">Error loading file: ${err.message}</div>`;
                    });
            }

            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');

            // Stop any playing media
            const video = document.getElementById('videoPlayer');
            const audio = document.getElementById('audioPlayer');
            if (video) {
                video.pause();
                video.src = '';
            }
            if (audio) {
                audio.pause();
                audio.src = '';
            }

            modal.classList.remove('active');
            content.innerHTML = '';
        }

        // Click outside to close
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show watch history
        async function showHistory() {
            try {
                const response = await fetch('/api/history');
                const data = await response.json();

                const modal = document.getElementById('modal');
                const content = document.getElementById('modalContent');

                if (data.count === 0) {
                    content.innerHTML = `
                        <div class="text-preview">
                            <div class="text-preview-header">Watch History</div>
                            <div style="padding: 2rem; text-align: center; color: #666;">
                                No watch history yet
                            </div>
                        </div>
                    `;
                } else {
                    let historyHtml = `
                        <div class="text-preview">
                            <div class="text-preview-header">Watch History (${data.count} items)</div>
                            <div style="padding: 1rem;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #e0e0e0;">
                                            <th style="padding: 0.5rem; text-align: left;">File</th>
                                            <th style="padding: 0.5rem; text-align: left;">Type</th>
                                            <th style="padding: 0.5rem; text-align: right;">Views</th>
                                            <th style="padding: 0.5rem; text-align: right;">Last Watched</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    data.history.forEach(item => {
                        const lastWatched = new Date(item.last_watched).toLocaleString();
                        const fileType = item.file_type.charAt(0).toUpperCase() + item.file_type.slice(1);

                        historyHtml += `
                            <tr style="border-bottom: 1px solid #f0f0f0; cursor: pointer;"
                                onclick='viewFile("${item.file_path}", "${item.file_type}", "${escapeHtml(item.file_name)}")'>
                                <td style="padding: 0.75rem;">${escapeHtml(item.file_name)}</td>
                                <td style="padding: 0.75rem;">${fileType}</td>
                                <td style="padding: 0.75rem; text-align: right;">${item.view_count}</td>
                                <td style="padding: 0.75rem; text-align: right; font-size: 0.85rem; color: #666;">${lastWatched}</td>
                            </tr>
                        `;
                    });

                    historyHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    content.innerHTML = historyHtml;
                }

                modal.classList.add('active');
            } catch (error) {
                console.error('Failed to load history:', error);
                alert('Failed to load watch history');
            }
        }
    </script>
</body>
</html>
